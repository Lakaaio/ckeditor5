/*
 *             Copyright (c) 2016 - 2023, CKSource Holding sp. z o.o. All rights reserved.
 *
 *
 *
 *
 *          +---------------------------------------------------------------------------------+
 *          |                                                                                 |
 *          |                                 Hello stranger!                                 |
 *          |                                                                                 |
 *          |                                                                                 |
 *          |   What you're currently looking at is the source code of a legally protected,   |
 *          |    proprietary software. Any attempts to deobfuscate / disassemble this code    |
 *          |               are forbidden and will result in legal consequences.              |
 *          |                                                                                 |
 *          |                                                                                 |
 *          +---------------------------------------------------------------------------------+
 *
 *
 *
 *
 */
'use strict';var __importDefault=this&&this['__importDefault']||function(_0x1fa32a){return _0x1fa32a&&_0x1fa32a['__esModule']?_0x1fa32a:{'default':_0x1fa32a};};Object['defineProperty'](exports,'__esModule',{'value':!0x0}),exports['_SERVICE']=void 0x0;const uuid_1=require('uuid'),utils_1=require('ckeditor5/src/utils'),messagescompressor_1=__importDefault(require('./../messagescompressor')),sessions_1=__importDefault(require('./../sessions/sessions')),collaborativeeditingconnectmessage_1=__importDefault(require('./messages/collaborativeeditingconnectmessage')),collaborativeeditingupdatemessage_1=__importDefault(require('./messages/collaborativeeditingupdatemessage')),collaborativeeditingreconnectmessage_1=__importDefault(require('./messages/collaborativeeditingreconnectmessage')),collaborativeeditingresponse_1=__importDefault(require('./responses/collaborativeeditingresponse')),collaborativeeditingconnectresponse_1=__importDefault(require('./responses/collaborativeeditingconnectresponse')),websocketgateway_1=__importDefault(require('./../websocketgateway/websocketgateway')),ckeditorcloudserviceserror_1=__importDefault(require('../ckeditorcloudserviceserror')),ServiceNotConnectedError_1=__importDefault(require('../errors/ServiceNotConnectedError')),getdocumentdetailsresponse_1=__importDefault(require('./responses/getdocumentdetailsresponse')),getdocumentdetailsmessage_1=__importDefault(require('./messages/getdocumentdetailsmessage'));exports['_SERVICE']=0x1;class CollaborativeEditingService extends(0x0,utils_1['EmitterMixin'])(){constructor(_0x29c5d6,_0x56758f){if(super(),!_0x29c5d6)throw new TypeError('Param\x20\x22bundleVersion\x22\x20must\x20be\x20provided.');this['_id']=null!=_0x56758f?_0x56758f:(0x0,uuid_1['v4'])(),this['_isConnected']=!0x1,this['_bundleVersion']=_0x29c5d6;}['getId'](){return this['_id'];}['isConnected'](){return this['_isConnected'];}['connect'](_0x5bd04a,_0x36e22c={'buffers':[],'types':[]},_0x52b9d3){const _0x36470e=new collaborativeeditingconnectmessage_1['default'](this['getId'](),_0x36e22c['buffers'],_0x36e22c['types'],this['_bundleVersion'],_0x52b9d3);return this['_connect'](_0x5bd04a,_0x36470e);}['reconnect'](_0x11d318,_0x1ab7e3){if(this['isConnected']())throw new ckeditorcloudserviceserror_1['default']('Cannot\x20reconnect\x20to\x20already\x20connected\x20service.',_0x11d318);return this['_connect'](_0x11d318,new collaborativeeditingreconnectmessage_1['default'](this['getId'](),_0x1ab7e3,this['_bundleVersion']));}['disconnect'](){this['_isConnected']&&(this['_isConnected']=!0x1,this['_wsGateway']&&(this['stopListening'](this['_wsGateway']),this['_wsGateway']=void 0x0),this['_channel']&&(this['stopListening'](this['_channel']),this['_channel']=void 0x0),this['_connectedSessions']&&(this['_connectedSessions']['disconnect'](),this['_connectedSessions']=void 0x0),this['fire']('disconnected'),this['stopListening']());}async['getDocumentDetails'](){const _0x1a6725=new getdocumentdetailsmessage_1['default'](this['getId']());if(!this['_wsGateway'])throw new ServiceNotConnectedError_1['default']('Collaborative\x20Editing',this);const _0x1c1619=await this['_wsGateway']['_sendRequest'](exports['_SERVICE'],getdocumentdetailsmessage_1['default']['TYPE'],messagescompressor_1['default']['encode'](_0x1a6725));return messagescompressor_1['default']['decode'](_0x1c1619,getdocumentdetailsresponse_1['default']);}async['sendOperations'](_0x45f7b6,_0x38835c,_0x4e837e){if(!_0x45f7b6||!_0x45f7b6['types']||!_0x45f7b6['types']['length'])throw new ckeditorcloudserviceserror_1['default']('Cannot\x20send\x20empty\x20update.',this['_wsGateway']);const _0x4bed2e='number'==typeof _0x38835c?_0x38835c:parseInt(_0x38835c);if(!Number['isInteger'](_0x4bed2e)||_0x4bed2e<0x0)throw new ckeditorcloudserviceserror_1['default']('Base\x20version\x20not\x20provided.',this['_wsGateway']);const _0x5c93bd=new collaborativeeditingupdatemessage_1['default'](this['getId'](),_0x45f7b6['buffers'],_0x45f7b6['types'],_0x4bed2e,[],_0x4e837e);if(!this['_wsGateway']||!this['_isConnected'])throw new ServiceNotConnectedError_1['default']('Collaborative\x20Editing',this);const _0x5a016e=await this['_wsGateway']['_sendRequest'](exports['_SERVICE'],collaborativeeditingupdatemessage_1['default']['TYPE'],messagescompressor_1['default']['encode'](_0x5c93bd));return messagescompressor_1['default']['decode'](_0x5a016e,collaborativeeditingresponse_1['default']);}async['getConnectedSessions'](){if(!this['_isConnected'])throw new ServiceNotConnectedError_1['default']('Collaborative\x20Editing',this);return this['_connectedSessions']||(this['_connectedSessions']=await sessions_1['default']['getConnectedSessions'](this['_wsGateway'],this['_id'],exports['_SERVICE'])),this['_connectedSessions'];}static['getConnectedSessions'](_0x20fc28,_0xb83415){return sessions_1['default']['getConnectedSessions'](_0x20fc28,_0xb83415,exports['_SERVICE']);}async['_connect'](_0xc86235,_0x39d083){if(this['isConnected']())return;if(_0xc86235['state']!==websocketgateway_1['default']['STATE_CONNECTED'])throw new ckeditorcloudserviceserror_1['default']('WebSocket\x20Gateway\x20is\x20not\x20connected.',_0xc86235);this['_wsGateway']=_0xc86235,this['stopListening'](_0xc86235,'change:state');const _0x46a584=await _0xc86235['_sendRequest'](exports['_SERVICE'],_0x39d083['constructor']['TYPE'],messagescompressor_1['default']['encode'](_0x39d083)),_0x5434c5=messagescompressor_1['default']['decode'](_0x46a584,collaborativeeditingconnectresponse_1['default']);return this['listenTo'](_0xc86235,'change:state',(_0x24f469,_0x5b99d3,_0x4391ae)=>this['_onWsGatewayStateChange'](_0x4391ae),{'priority':websocketgateway_1['default']['_CHANGE_STATE_EVENT_PRIORITY']}),this['_connectToChannel'](_0xc86235,_0x5434c5['channel']),this['_isConnected']=!0x0,this['fire']('connected'),_0x5434c5;}['_connectToChannel'](_0x43167a,_0x501a7b){this['_channel']=_0x43167a['_getChannel'](exports['_SERVICE'],_0x501a7b),this['listenTo'](this['_channel'],this['_channel']['getEventName'](collaborativeeditingupdatemessage_1['default']['TYPE']),(_0x1b5555,_0x4c9755)=>{const _0x8a12b1=messagescompressor_1['default']['decode'](_0x4c9755,collaborativeeditingupdatemessage_1['default']);this['fire']('operationsReceived',_0x8a12b1['baseVersion'],_0x8a12b1['data'],_0x8a12b1['metadata']);});}['_onWsGatewayStateChange'](_0x58eadf){_0x58eadf===websocketgateway_1['default']['STATE_DISCONNECTED']&&this['disconnect']();}}CollaborativeEditingService['_SERVICE']=exports['_SERVICE'],exports['default']=CollaborativeEditingService;