/*
 *             Copyright (c) 2016 - 2023, CKSource Holding sp. z o.o. All rights reserved.
 *
 *
 *
 *
 *          +---------------------------------------------------------------------------------+
 *          |                                                                                 |
 *          |                                 Hello stranger!                                 |
 *          |                                                                                 |
 *          |                                                                                 |
 *          |   What you're currently looking at is the source code of a legally protected,   |
 *          |    proprietary software. Any attempts to deobfuscate / disassemble this code    |
 *          |               are forbidden and will result in legal consequences.              |
 *          |                                                                                 |
 *          |                                                                                 |
 *          +---------------------------------------------------------------------------------+
 *
 *
 *
 *
 */
'use strict';var __importDefault=this&&this['__importDefault']||function(_0x363a1e){return _0x363a1e&&_0x363a1e['__esModule']?_0x363a1e:{'default':_0x363a1e};};Object['defineProperty'](exports,'__esModule',{'value':!0x0}),exports['WEB_SOCKET_GATEWAY_STATES']=void 0x0;const socket_io_client_1=require('socket.io-client'),url_parse_1=__importDefault(require('url-parse')),utils_1=require('ckeditor5/src/utils'),channel_1=__importDefault(require('./channel')),user_1=__importDefault(require('./../users/user')),version_1=__importDefault(require('./../version')),ckeditorcloudserviceserror_1=__importDefault(require('./../ckeditorcloudserviceserror')),ckeditorcloudservicesservererror_1=__importDefault(require('./../ckeditorcloudservicesservererror')),parser_1=require('./parser/parser'),requestsmanager_1=__importDefault(require('./requestsmanager'));var WEB_SOCKET_GATEWAY_STATES;!function(_0xad3183){_0xad3183['DISCONNECTED']='disconnected',_0xad3183['CONNECTING']='connecting',_0xad3183['CONNECTED']='connected';}(WEB_SOCKET_GATEWAY_STATES=exports['WEB_SOCKET_GATEWAY_STATES']||(exports['WEB_SOCKET_GATEWAY_STATES']={}));class WebSocketGateway extends(0x0,utils_1['ObservableMixin'])(){constructor(_0x2c0683,_0x57ea42,_0x11bd5b={},_0x495bfb=socket_io_client_1['io'],_0x55cb72=user_1['default']['get']){if(super(),this['_token']=_0x57ea42,this['_options']=_0x11bd5b,this['_connectionProvider']=_0x495bfb,this['_userFactory']=_0x55cb72,this['_requestsManager']=new requestsmanager_1['default'](this),this['_channels']=new Map(),this['_connectionAttempt']=0x0,!_0x2c0683)throw new TypeError('Api\x20address\x20must\x20be\x20provided.');if(!this['_token'])throw new TypeError('Token\x20must\x20be\x20provided.');this['_options']['requestTimeout']||(this['_options']['requestTimeout']=0x4e20),this['_url']=(0x0,url_parse_1['default'])(_0x2c0683['replace'](/^(?!(?:\w+:)?\/\/)/,'https://')),this['set']('state',WEB_SOCKET_GATEWAY_STATES['DISCONNECTED']),this['set']('socketId',void 0x0),this['set']('me',void 0x0),this['on']('change:state',async(_0x37ff58,_0x2a5897,_0xc11176)=>{var _0x1271e8;if(this['_debugEvent']('ws-gw:change:state',_0xc11176),_0xc11176!==WebSocketGateway['STATE_CONNECTED']){if(_0xc11176===WebSocketGateway['STATE_DISCONNECTED'])return this['_requestsManager']['errorAll'](new ckeditorcloudserviceserror_1['default']('Not\x20connected.',this));}else try{this['me']=await this['_userFactory']['call'](user_1['default'],this,null===(_0x1271e8=this['_socketAuth'])||void 0x0===_0x1271e8?void 0x0:_0x1271e8['userId']);}catch(_0x370d33){}},{'priority':WebSocketGateway['_CHANGE_STATE_EVENT_PRIORITY']}),this['on']('error',(_0x338b71,_0x2dc3b0)=>{this['_options']['onError']?this['_options']['onError'](_0x2dc3b0):console['error'](_0x2dc3b0);});}get['sessionId'](){return this['socketId'];}['waitForAllRequests'](_0x249b5e){return this['_requestsManager']['waitForAllRequests'](_0x249b5e);}['disconnect'](){var _0x458231;this['state']!==WEB_SOCKET_GATEWAY_STATES['DISCONNECTED']&&(null===(_0x458231=this['_socket'])||void 0x0===_0x458231||_0x458231['disconnect'](),this['_socket']=void 0x0,this['state']=WEB_SOCKET_GATEWAY_STATES['DISCONNECTED']);}async['reconnect'](){this['_socket']||this['state']!==WEB_SOCKET_GATEWAY_STATES['DISCONNECTED']||(await this['_token']['refreshToken'](),await this['_connect']());}static async['connect'](_0x4ee55c,_0x25ddee='local.cs.dev:443/ws-v2',_0x1e8ca9={},_0x17a3ea=socket_io_client_1['io'],_0x2ef654=user_1['default']['get']){const _0x4751a9=new WebSocketGateway(_0x25ddee,_0x4ee55c,_0x1e8ca9,_0x17a3ea,_0x2ef654);return await _0x4751a9['_connect'](),_0x4751a9;}['_sendRequest'](_0xb5bef1,_0x3c9834,_0x20e6c5){if(!_0xb5bef1)throw new ckeditorcloudserviceserror_1['default']('`serviceName`\x20must\x20be\x20provided.',this);if(this['state']!==WebSocketGateway['STATE_CONNECTED'])throw new ckeditorcloudserviceserror_1['default']('Not\x20connected.',this);if(!this['_socketAuth']||!this['_socketAuth']['isAuthenticated'])throw new ckeditorcloudserviceserror_1['default']('Not\x20authenticated.',this);const _0x3e3793=new ArrayBuffer(_0x20e6c5['length']+0x2),_0x1bad46=new Uint8Array(_0x3e3793);return _0x1bad46[0x0]=_0xb5bef1,_0x1bad46[0x1]=parseInt(_0x3c9834),_0x1bad46['set'](_0x20e6c5,0x2),this['_emit'](0x1,_0x1bad46);}['_getChannel'](_0x305f8c,_0x2b8a7e){const _0x4c1eeb=''+_0x305f8c+_0x2b8a7e;return!this['_channels']['has'](_0x4c1eeb)&&this['_socket']&&this['_channels']['set'](_0x4c1eeb,new channel_1['default'](_0x4c1eeb,this,this['_socket'])),this['_channels']['get'](_0x4c1eeb);}['_connect'](){return new Promise((_0x1f6e0b,_0x20cce3)=>{const _0x4f28f1=this['_setupSocket']();!this['socketId']&&_0x4f28f1['io']['on']('reconnect_error',()=>{this['_debugEvent']('reconnect_error'),this['_reconnectionAttemptError'](_0x20cce3);}),_0x4f28f1['once']('connect',async()=>{this['_debugEvent']('once-connect');try{await this['_onConnect'](),_0x1f6e0b();}catch(_0x2dad20){_0x20cce3(_0x2dad20);}}),_0x4f28f1['connect']();});}['_getPortByProtocol'](_0x23a315){return['http:','ws:']['includes'](_0x23a315)?0x50:0x1bb;}['_setupSocket'](){var _0x4a7145;if(this['_socket'])return this['_socket'];const _0xe46f67=this['_url']['port']||this['_getPortByProtocol'](this['_url']['protocol']),_0x316aea=(this['_url']['protocol']||'https:')+'//'+this['_url']['hostname']+':'+_0xe46f67,_0x1bb88a=this['_url']['pathname']['match'](/^\/.*\/ws/)?this['_url']['pathname']['split']('/ws')[0x0]:'',_0x14e1be=this['_connectionProvider'](_0x316aea,{'parser':{'Encoder':parser_1['Encoder'],'Decoder':parser_1['Decoder']},'path':_0x1bb88a+'/ws-v2/ws','transports':['websocket'],'timeout':void 0x0!==this['_options']['timeout']?this['_options']['timeout']:0x1388,'reconnection':void 0x0===this['_options']['autoReconnect']||this['_options']['autoReconnect'],'reconnectionDelay':0x3e8,'reconnectionDelayMax':0x1388,'rejectUnauthorized':void 0x0===this['_options']['rejectUnauthorized']||this['_options']['rejectUnauthorized'],'query':{'version':version_1['default']},'agent':null!==(_0x4a7145=this['_options']['agent'])&&void 0x0!==_0x4a7145&&_0x4a7145,'closeOnBeforeunload':!0x1});return this['state']=WEB_SOCKET_GATEWAY_STATES['CONNECTING'],_0x14e1be['on']('connect',()=>{this['_debugEvent']('connect'),this['socketId']=_0x14e1be['id'];}),_0x14e1be['on']('connect_error',_0x1403e1=>{this['_debugEvent']('connect_error',_0x1403e1);}),_0x14e1be['on']('disconnect',()=>{this['_debugEvent']('disconnect'),this['_onDisconnect']();}),_0x14e1be['io']['on']('reconnect',async()=>{this['_debugEvent']('reconnect'),await this['_onReconnect']();}),_0x14e1be['io']['on']('reconnect_attempt',_0x3a8d80=>{this['_debugEvent']('reconnect_attempt',_0x3a8d80),this['state']=WEB_SOCKET_GATEWAY_STATES['CONNECTING'],this['_connectionAttempt']=_0x3a8d80;}),_0x14e1be['on']('unauthorized',_0x463cd6=>{this['_debugEvent']('unauthorized'),this['_onUnauthorized'](_0x463cd6);}),_0x14e1be['on']('authenticationRequest',async _0xedd49b=>{this['_debugEvent']('authenticationRequest',_0xedd49b['attempt']),await this['_onReconnect']();}),this['_socket']=_0x14e1be,_0x14e1be;}['_emit'](_0x3ebbee,_0x4ee716){const _0x59bf8b=this['_socket'];return this['_requestsManager']['send'](_0x36529a=>{_0x59bf8b['emit'](_0x3ebbee,_0x4ee716,(_0x4e715c,_0x2286f)=>{if(_0x4e715c)return _0x36529a['error'](ckeditorcloudservicesservererror_1['default']['fromPublicError'](_0x4e715c));_0x36529a['response'](_0x2286f);});},this['_options']['requestTimeout']);}['_addAuthData'](_0x5370b1,_0x31eca3){this['_socketAuth']={'environmentId':_0x5370b1,'userId':_0x31eca3,'isAuthenticated':!0x0};}['_removeAuthData'](){this['_socketAuth']=void 0x0;}async['_onConnect'](){await this['_authenticate'](this['_token']['value']),this['state']=WEB_SOCKET_GATEWAY_STATES['CONNECTED'];const _0x1f767a=async(_0x12d9e4,_0x87ee98,_0xbcf12e)=>{this['_debugEvent']('token:value:change');try{await this['_authenticate'](_0xbcf12e);}catch(_0x337057){}};this['_token']['on']('change:value',_0x1f767a),this['_socket']['io']['off']('reconnect_error'),this['on']('disconnect',()=>{this['_token']['off']('change:value',_0x1f767a);});}async['_onReconnect'](){await this['_token']['refreshToken'](),await this['_onConnect']();}['_onDisconnect'](){this['state']=WEB_SOCKET_GATEWAY_STATES['DISCONNECTED'],this['_connectionAttempt']=0x0,this['fire']('disconnect');for(const _0x3eaecf of this['_channels']['values']())_0x3eaecf['remove']();this['_channels']['clear'](),void 0x0===this['_options']['autoReconnect']||this['_options']['autoReconnect']||(this['_socket']=void 0x0);}['_debugEvent'](_0xd380c1,_0xb742f6){if(!this['_isDebugModeEnabled']())return;const _0x2fbc6d=void 0x0!==_0xb742f6?',\x20data:\x20'+_0xb742f6:'';console['info'](new Date()['toLocaleString']()+'\x20'+_0xd380c1+_0x2fbc6d);}['_reconnectionAttemptError'](_0x1c4afd){this['_connectionAttempt']>=0x2&&(this['disconnect'](),_0x1c4afd(ckeditorcloudserviceserror_1['default']['fromPublicError']({'message':'The\x20number\x20of\x20initial\x20connection\x20attempts\x20exceeded.','explanation':'Three\x20initial\x20connection\x20attempts\x20failed.\x20It\x20can\x20be\x20caused\x20by\x20a\x20missing\x20or\x20blocked\x20Internet\x20connection.','action':'Please\x20verify\x20the\x20stability\x20of\x20your\x20Internet\x20connection\x20and\x20ensure\x20that\x20no\x20antivirus\x20or\x20firewall\x20software\x20blocks\x20the\x20Web\x20Socket\x20protocol\x20connections.'})));}['_onUnauthorized']({error:error}){this['_removeAuthData'](),this['fire']('error',ckeditorcloudservicesservererror_1['default']['fromPublicError'](error));}async['_authenticate'](_0xb0f59b){try{this['_debugEvent']('authenticate:start');const _0x5a7913=await this['_emit'](0x2,{'token':_0xb0f59b});this['_debugEvent']('authenticate:success','envId:\x20'+_0x5a7913['environmentId']+',\x20userId:\x20'+_0x5a7913['userId']),this['_addAuthData'](_0x5a7913['environmentId'],_0x5a7913['userId']);}catch(_0x27230e){throw this['_debugEvent']('authenticate:error',_0x27230e['message']),this['_removeAuthData'](),_0x27230e;}}['_isDebugModeEnabled'](){var _0x558940;if(!utils_1['global']['window']['localStorage'])return!0x1;return'true'===(null!==(_0x558940=utils_1['global']['window']['localStorage']['getItem']('csClientDebugMode'))&&void 0x0!==_0x558940?_0x558940:'false')['toLowerCase']();}}WebSocketGateway['STATE_DISCONNECTED']=WEB_SOCKET_GATEWAY_STATES['DISCONNECTED'],WebSocketGateway['STATE_CONNECTING']=WEB_SOCKET_GATEWAY_STATES['CONNECTING'],WebSocketGateway['STATE_CONNECTED']=WEB_SOCKET_GATEWAY_STATES['CONNECTED'],WebSocketGateway['_CHANGE_STATE_EVENT_PRIORITY']=utils_1['priorities']['get']('highest')+0xf423f,exports['default']=WebSocketGateway;