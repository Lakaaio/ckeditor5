/*
 *             Copyright (c) 2016 - 2023, CKSource Holding sp. z o.o. All rights reserved.
 *
 *
 *
 *
 *          +---------------------------------------------------------------------------------+
 *          |                                                                                 |
 *          |                                 Hello stranger!                                 |
 *          |                                                                                 |
 *          |                                                                                 |
 *          |   What you're currently looking at is the source code of a legally protected,   |
 *          |    proprietary software. Any attempts to deobfuscate / disassemble this code    |
 *          |               are forbidden and will result in legal consequences.              |
 *          |                                                                                 |
 *          |                                                                                 |
 *          +---------------------------------------------------------------------------------+
 *
 *
 *
 *
 */
'use strict';var __importDefault=this&&this['__importDefault']||function(_0xb7f59b){return _0xb7f59b&&_0xb7f59b['__esModule']?_0xb7f59b:{'default':_0xb7f59b};};Object['defineProperty'](exports,'__esModule',{'value':!0x0});const utils_1=require('ckeditor5/src/utils'),sessions_1=require('./sessions'),user_1=__importDefault(require('./../users/user')),websocketgateway_1=__importDefault(require('./../websocketgateway/websocketgateway')),sessionsconnectresponse_1=__importDefault(require('./responses/sessionsconnectresponse')),sessionsconnectmessage_1=__importDefault(require('./messages/sessionsconnectmessage')),socketconnectmessage_1=__importDefault(require('./messages/socketconnectmessage')),socketdisconnectmessage_1=__importDefault(require('./messages/socketdisconnectmessage')),messagescompressor_1=__importDefault(require('./../messagescompressor'));class SessionCollection extends utils_1['Collection']{constructor(_0x40af00,_0x315ed2){super({'idProperty':'id'}),this['_id']=_0x40af00,this['_sessionType']=_0x315ed2,this['_handlers']=new Map(),this['_eventsQueue']=[],this['_isRunning']=!0x1;}async['connect'](_0x5501cd){this['_wsGateway']=_0x5501cd,this['stopListening'](_0x5501cd,'change:state');const _0x14d656=new sessionsconnectmessage_1['default'](this['_id'],this['_sessionType']);let _0x53c58a;try{const _0x3a326f=await this['_wsGateway']['_sendRequest'](sessions_1['_SERVICE'],sessionsconnectmessage_1['default']['TYPE'],messagescompressor_1['default']['encode'](_0x14d656));_0x53c58a=messagescompressor_1['default']['decode'](_0x3a326f,sessionsconnectresponse_1['default']);}catch(_0x4a76ef){_0x53c58a=new sessionsconnectresponse_1['default'](this['_id'],[]);}this['_connectToChannel'](this['_wsGateway'],_0x53c58a['channel'],this['_sessionType']);const _0x307f1d=await async function(_0x1a6a2a,_0x49fbc6){const _0x5eb6f5=_0x49fbc6['map'](_0x3e3a7b=>_0x3e3a7b['userId']),_0x2edb73=_0x5eb6f5['length']?await user_1['default']['getMany'](_0x1a6a2a,_0x5eb6f5):[];return _0x49fbc6['map'](_0x539bc6=>{const _0x3fd03b={'id':_0x539bc6['id'],'role':_0x539bc6['role'],'permissions':_0x539bc6['permissions']};return _0x3fd03b['user']=_0x539bc6['userId']&&_0x2edb73['find'](_0x2c5d9e=>_0x2c5d9e['id']===_0x539bc6['userId'])||new user_1['default'](),_0x3fd03b;});}(this['_wsGateway'],_0x53c58a['sockets']);for(const _0x18eb6a of _0x307f1d)super['add'](_0x18eb6a);this['_connected']=!0x0,this['fire']('connected'),this['listenTo'](this['_wsGateway'],'change:state',(_0x49f4da,_0x3dd5f8,_0xc322a)=>this['_onWsGatewayStateChange'](_0xc322a),{'priority':websocketgateway_1['default']['_CHANGE_STATE_EVENT_PRIORITY']}),await this['_runQueue']();}['disconnect'](_0x5e0cba=!0x0){if(this['_connected']){for(this['_connected']=!0x1,this['_eventsQueue']=[];this['length'];)super['remove'](0x0);this['_channel']&&(this['stopListening'](this['_channel']),this['_channel']=void 0x0),this['_wsGateway']&&_0x5e0cba&&(this['stopListening'](this['_wsGateway']),this['_wsGateway']=void 0x0),this['fire']('disconnected'),_0x5e0cba&&this['stopListening']();}}['add'](_0x2fe84b,_0x30ed8){throw new TypeError('The\x20collection\x20is\x20read-only.');}['remove'](_0x37aed6){throw new TypeError('The\x20collection\x20is\x20read-only.');}['_connectToChannel'](_0xa51e44,_0x26279c,_0x206d42){this['_channel']=_0xa51e44['_getChannel'](_0x206d42,_0x26279c),this['_channel']&&(this['_addHandler'](this['_channel'],socketconnectmessage_1['default']['TYPE'],async _0x5a4c0c=>{const _0x12410e=messagescompressor_1['default']['decode'](_0x5a4c0c,socketconnectmessage_1['default']);if(-0x1===this['getIndex'](_0x12410e['id'])){const _0x5ef16f={'id':_0x12410e['id'],'role':_0x12410e['role'],'permissions':_0x12410e['permissions']};_0x12410e['userId']&&(_0x5ef16f['user']=await user_1['default']['get'](_0xa51e44,_0x12410e['userId'])),super['add'](_0x5ef16f);}}),this['_addHandler'](this['_channel'],socketdisconnectmessage_1['default']['TYPE'],_0x57c345=>{const _0x312dad=messagescompressor_1['default']['decode'](_0x57c345,socketdisconnectmessage_1['default']);-0x1!==this['getIndex'](_0x312dad['id'])&&super['remove'](_0x312dad['id']);}));}async['_onWsGatewayStateChange'](_0xfe7ba8){_0xfe7ba8===websocketgateway_1['default']['STATE_DISCONNECTED']&&this['disconnect'](!0x1),_0xfe7ba8===websocketgateway_1['default']['STATE_CONNECTED']&&await this['connect'](this['_wsGateway']);}async['_runQueue'](){if(this['_isRunning']||!this['_connected'])return;let _0x50d92e;for(this['_isRunning']=!0x0;_0x50d92e=this['_eventsQueue']['shift']();){const _0x4ef0d8=this['_handlers']['get'](_0x50d92e['eventName']);_0x4ef0d8&&await _0x4ef0d8(_0x50d92e['data']);}this['_isRunning']=!0x1;}['_addHandler'](_0x1a6226,_0x4edf94,_0x40d5bf){const _0x120270=_0x1a6226['getEventName'](_0x4edf94,!0x0);this['listenTo'](_0x1a6226,_0x120270,async(_0x3121f5,_0x5e2902)=>{const _0x4e9d01=_0x3121f5['name'];this['_eventsQueue']['push']({'eventName':_0x4e9d01,'data':_0x5e2902}),await this['_runQueue']();}),this['_handlers']['set'](_0x120270,_0x40d5bf);}}exports['default']=SessionCollection;